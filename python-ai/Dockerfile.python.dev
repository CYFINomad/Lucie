FROM python:3.11-slim

# Installer les dépendances système nécessaires
RUN apt-get update && apt-get install -y \
    build-essential \
    python3-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copier les requirements
COPY requirements.txt .

# Mettre à jour pip
RUN pip install --upgrade pip

# Installer les dépendances en excluant snyk-python-agent
RUN pip install --no-cache-dir "numpy>=1.24.0,<1.26.0" && \
    pip install --no-cache-dir "torch>=2.0.0" --index-url https://download.pytorch.org/whl/cpu && \
    pip install --no-cache-dir "transformers>=4.30.0" "sentence-transformers>=2.2.0" && \
    pip install --no-cache-dir fastapi==0.104.1 uvicorn[standard]==0.24.0 pydantic==2.4.2 \
    python-dotenv==1.0.0 neo4j==5.14.0 redis==5.0.1 \
    grpcio==1.59.2 grpcio-tools==1.59.2 \
    pytest==7.4.3 pytest-cov==4.1.0 black==23.10.1 pylint==3.0.2 \
    requests==2.31.0 httpx==0.25.1 tenacity==8.2.3 \
    # snyk-python-agent==0.3.0 est supprimé ici
    pip install debugpy


# Copier le reste de l'application
COPY . .

EXPOSE 8000 50051 5678

CMD ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]